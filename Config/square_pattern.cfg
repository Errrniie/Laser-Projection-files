# =============================================================================
# SQUARE DETERRENCE PATTERN MACROS FOR KLIPPER
# =============================================================================
#
# These macros implement a square perimeter pattern for laser deterrence.
# Python computes all geometry and sends absolute motor positions.
# Klipper only handles motion timing.
#
# Usage from Python:
#   1. SQUARE_DEFINE X1=... Y1=... X2=... Y2=... X3=... Y3=... X4=... Y4=... SPEED=... DWELL=...
#   2. SQUARE_START
#   3. SQUARE_STOP (to halt)
#
# Pattern order: 1 → 2 → 3 → 4 → 1 → ... (loops until stopped)
#
# Add this to your printer.cfg or include it:
#   [include square_pattern.cfg]
#
# =============================================================================

# -----------------------------------------------------------------------------
# PERSISTENT VARIABLES (stored in save_variables.cfg)
# -----------------------------------------------------------------------------
# Requires: [save_variables] in printer.cfg
# These store the pattern corners and settings between macro calls.

[gcode_macro SQUARE_DEFINE]
description: Define a square pattern with 4 corner positions
gcode:
    # Store corner positions (absolute motor positions in mm)
    SET_GCODE_VARIABLE MACRO=_SQUARE_STATE VARIABLE=x1 VALUE={params.X1|default(0)|float}
    SET_GCODE_VARIABLE MACRO=_SQUARE_STATE VARIABLE=y1 VALUE={params.Y1|default(0)|float}
    SET_GCODE_VARIABLE MACRO=_SQUARE_STATE VARIABLE=x2 VALUE={params.X2|default(0)|float}
    SET_GCODE_VARIABLE MACRO=_SQUARE_STATE VARIABLE=y2 VALUE={params.Y2|default(0)|float}
    SET_GCODE_VARIABLE MACRO=_SQUARE_STATE VARIABLE=x3 VALUE={params.X3|default(0)|float}
    SET_GCODE_VARIABLE MACRO=_SQUARE_STATE VARIABLE=y3 VALUE={params.Y3|default(0)|float}
    SET_GCODE_VARIABLE MACRO=_SQUARE_STATE VARIABLE=x4 VALUE={params.X4|default(0)|float}
    SET_GCODE_VARIABLE MACRO=_SQUARE_STATE VARIABLE=y4 VALUE={params.Y4|default(0)|float}
    
    # Store speed and dwell settings
    SET_GCODE_VARIABLE MACRO=_SQUARE_STATE VARIABLE=speed VALUE={params.SPEED|default(12000)|int}
    SET_GCODE_VARIABLE MACRO=_SQUARE_STATE VARIABLE=dwell_ms VALUE={params.DWELL|default(100)|int}
    
    # Reset to corner 1
    SET_GCODE_VARIABLE MACRO=_SQUARE_STATE VARIABLE=current_corner VALUE=1
    
    { action_respond_info("Square pattern defined: 4 corners, speed=%d, dwell=%dms" % (params.SPEED|default(12000)|int, params.DWELL|default(100)|int)) }

# -----------------------------------------------------------------------------
# PATTERN STATE STORAGE
# -----------------------------------------------------------------------------

[gcode_macro _SQUARE_STATE]
description: Internal state storage for square pattern
variable_x1: 0.0
variable_y1: 0.0
variable_x2: 0.0
variable_y2: 0.0
variable_x3: 0.0
variable_y3: 0.0
variable_x4: 0.0
variable_y4: 0.0
variable_speed: 12000
variable_dwell_ms: 100
variable_current_corner: 1
variable_running: 0
gcode:
    # This macro just stores variables, no direct execution

# -----------------------------------------------------------------------------
# PATTERN CONTROL
# -----------------------------------------------------------------------------

[gcode_macro SQUARE_START]
description: Start the square deterrence pattern
gcode:
    # Mark pattern as running
    SET_GCODE_VARIABLE MACRO=_SQUARE_STATE VARIABLE=running VALUE=1
    SET_GCODE_VARIABLE MACRO=_SQUARE_STATE VARIABLE=current_corner VALUE=1
    
    { action_respond_info("Square pattern starting...") }
    
    # Move to corner 1 to start
    _SQUARE_MOVE_TO_CORNER CORNER=1
    
    # Schedule the first step
    UPDATE_DELAYED_GCODE ID=_square_step DURATION=0.001

[gcode_macro SQUARE_STOP]
description: Stop the square deterrence pattern immediately
gcode:
    # Mark pattern as stopped
    SET_GCODE_VARIABLE MACRO=_SQUARE_STATE VARIABLE=running VALUE=0
    
    # Cancel any pending delayed gcode
    UPDATE_DELAYED_GCODE ID=_square_step DURATION=0
    
    { action_respond_info("Square pattern stopped") }

# -----------------------------------------------------------------------------
# PATTERN STEPPING (internal)
# -----------------------------------------------------------------------------

[delayed_gcode _square_step]
initial_duration: 0
gcode:
    {% set state = printer["gcode_macro _SQUARE_STATE"] %}
    
    {% if state.running == 1 %}
        # Get current corner and advance to next
        {% set corner = state.current_corner %}
        {% set next_corner = (corner % 4) + 1 %}
        
        # Update corner for next iteration
        SET_GCODE_VARIABLE MACRO=_SQUARE_STATE VARIABLE=current_corner VALUE={next_corner}
        
        # Move to next corner
        _SQUARE_MOVE_TO_CORNER CORNER={next_corner}
        
        # Calculate delay: dwell time + estimated move time
        # For simplicity, use dwell_ms as the base delay
        {% set delay_s = state.dwell_ms / 1000.0 %}
        {% if delay_s < 0.05 %}
            {% set delay_s = 0.05 %}
        {% endif %}
        
        # Schedule next step
        UPDATE_DELAYED_GCODE ID=_square_step DURATION={delay_s}
    {% endif %}

[gcode_macro _SQUARE_MOVE_TO_CORNER]
description: Move to a specific corner (internal use)
gcode:
    {% set state = printer["gcode_macro _SQUARE_STATE"] %}
    {% set corner = params.CORNER|int %}
    {% set speed = state.speed %}
    
    {% if corner == 1 %}
        G1 X{state.x1} Y{state.y1} F{speed}
    {% elif corner == 2 %}
        G1 X{state.x2} Y{state.y2} F{speed}
    {% elif corner == 3 %}
        G1 X{state.x3} Y{state.y3} F{speed}
    {% elif corner == 4 %}
        G1 X{state.x4} Y{state.y4} F{speed}
    {% endif %}

# -----------------------------------------------------------------------------
# DEBUG / STATUS
# -----------------------------------------------------------------------------

[gcode_macro SQUARE_STATUS]
description: Print current square pattern status
gcode:
    {% set state = printer["gcode_macro _SQUARE_STATE"] %}
    
    { action_respond_info("Square Pattern Status:") }
    { action_respond_info("  Running: %s" % ("YES" if state.running == 1 else "NO")) }
    { action_respond_info("  Current corner: %d" % state.current_corner) }
    { action_respond_info("  Speed: %d mm/min" % state.speed) }
    { action_respond_info("  Dwell: %d ms" % state.dwell_ms) }
    { action_respond_info("  Corner 1: X=%.3f Y=%.3f" % (state.x1, state.y1)) }
    { action_respond_info("  Corner 2: X=%.3f Y=%.3f" % (state.x2, state.y2)) }
    { action_respond_info("  Corner 3: X=%.3f Y=%.3f" % (state.x3, state.y3)) }
    { action_respond_info("  Corner 4: X=%.3f Y=%.3f" % (state.x4, state.y4)) }
